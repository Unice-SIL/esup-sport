{% extends "@Uca/Common/Liste/Datatable.html.twig" %}

{% block DatatableHeader %}
    <div class="well">
        {{ form_start(form)}}
        <div class="row">
            <div class="col-sm-3">
                {{ form_row(form.nom) }}
            </div>
            <div class="col-sm-3">
                {{ form_row(form.prenom) }}
            </div>
                <div class="col-sm-3">
                {{ form_row(form.statut) }}
            </div>
            <div class="col-sm-3">
            </div>
            <div class="col-sm-3">
                {{ form_row(form.type_activite) }}
            </div>
                <div class="col-sm-3">
                {{ form_row(form.classe_activite) }}
            </div>
            <div class="col-sm-3">
                {{ form_row(form.activite) }}
            </div>
            <div class="col-sm-3">
                {{ form_row(form.formatActivite) }}
            </div>
                <div class="col-sm-3">
                {{ form_row(form.creneau) }}
            </div>
            <div class="col-sm-12">
            </div>
        </div>
        {{ form_end(form) }}
    </div>
{% endblock %} 

{% block javascripts %}
    {{ parent() }}
    {% if app.request.attributes.get("_route") == "UcaGest_GestionInscription" %}
        <script type="text/javascript">

            $(document).ready(function() {       

                // On cache les select de format d'activite et de creneau
                $('.hidden').closest('.form-group').hide();
                $('.select2-hidden-accessible').select2('destroy').select2().trigger('change.select2');
                var oTable = $('#sg-datatables-gestioninscription_datatable').DataTable();
                
                $('.champRechercheDatatableInscription').on('change', function() {
               
                    var valueNom = $('#ucabundle_inscription_nom').val();
                    var valuePrenom = $('#ucabundle_inscription_prenom').val();
                    var valueStatut = $('#ucabundle_inscription_statut').val() == 0 ? null : $('#ucabundle_inscription_statut').val();
                    var valueActivite = {id: 0, recherche: ''};

                    // Selon le select et l'option choisie on modifie les options des select qui en decoule
                    if($(this).attr('id') == 'ucabundle_inscription_type_activite'){
                        changeSelectOption($('#ucabundle_inscription_type_activite').val(), 'classe_activite', 'type_activite');
                        changeSelectOption($('#ucabundle_inscription_type_activite').val(), 'activite', 'type_activite');
                    }
                    if($(this).attr('id') == 'ucabundle_inscription_classe_activite'){
                        changeSelectOption($('#ucabundle_inscription_classe_activite').val(), 'activite', 'classe_activite');
                    }
                    if($(this).attr('id') == 'ucabundle_inscription_activite'){
                        changeSelectOption($('#ucabundle_inscription_activite').val(), 'formatActivite', 'activite');
                        $('#ucabundle_inscription_formatActivite').closest('.form-group').show();
                    }
                    if($(this).attr('id') == 'ucabundle_inscription_formatActivite'){
                        changeSelectOption($('#ucabundle_inscription_formatActivite').val(), 'creneau', 'format_activite');
                        if($('#ucabundle_inscription_formatActivite option:selected').attr('data-creneau') == 'true'){
                            $('#ucabundle_inscription_creneau').closest('.form-group').show();
                        }else{
                            $('#ucabundle_inscription_creneau').closest('.form-group').hide();
                        }
                    }

                    // Selon les select modifies on fait apparaitre les select format d'activite/creneau
                    if($('#ucabundle_inscription_formatActivite').val() == '0' && $('#ucabundle_inscription_creneau').css('display') != 'none' ){
                        $('#ucabundle_inscription_creneau').val('0').trigger('change.select2');
                        $('#ucabundle_inscription_creneau').closest('.form-group').hide();
                    }
                    if($('#ucabundle_inscription_activite').val() == '0' && $('#ucabundle_inscription_formatActivite').css('display') != 'none' ){
                        $('#ucabundle_inscription_formatActivite').val('0').trigger('change.select2');
                        $('#ucabundle_inscription_formatActivite').closest('.form-group').hide();
                    }

                    // On indique quelles valeurs a chercher pour datatable en AJAX
                    if($('#ucabundle_inscription_type_activite').val() != '0' && $('#ucabundle_inscription_type_activite').val() != null){
                        valueActivite['id'] = $('#ucabundle_inscription_type_activite').val();
                        valueActivite['recherche'] = 'TypeActivite';
                    }
                    if($('#ucabundle_inscription_classe_activite').val() != '0' && $('#ucabundle_inscription_classe_activite').val() != null){
                        valueActivite['id'] = $('#ucabundle_inscription_classe_activite').val();
                        valueActivite['recherche'] = 'ClasseActivite';
                    }
                    if($('#ucabundle_inscription_activite').val() != '0' && $('#ucabundle_inscription_activite').val() != null){
                        valueActivite['id'] = $('#ucabundle_inscription_activite').val();
                        valueActivite['recherche'] = 'Activite';

                    }
                    if($('#ucabundle_inscription_formatActivite').val() != '0' && $('#ucabundle_inscription_formatActivite').val() != null){
                        valueActivite['id'] = $('#ucabundle_inscription_formatActivite').val();
                        valueActivite['recherche'] = 'FormatActivite';
                    }
                    if($('#ucabundle_inscription_creneau').val() != '0' && $('#ucabundle_inscription_creneau').val() != null){
                        valueActivite['id'] = $('#ucabundle_inscription_creneau').val();
                        if($('#ucabundle_inscription_creneau option:selected').attr('data-type') == 'format'){
                            valueActivite['recherche'] = 'allCreneaux';
                        }else{
                            valueActivite['recherche'] = 'Creneau';
                        }
                    }
                    
                    var searchValue = JSON.stringify({ id: valueActivite['id'], recherche: valueActivite['recherche'] });

                    // Indication de la recherche
                    oTable.column(16).search(valueStatut,true,false);
                    oTable.column(14).search(searchValue,true,false);
                    oTable.column(12).search(valueNom,true,false);
                    oTable.column(13).search(valuePrenom,true,false);
                    oTable.ajax.reload();
                });

                // Fonction qui cache les options de select inutiles dues au choix fait sur le select 'parent'
                function changeSelectOption(idValue, dataIdSelect, dataIdChanged){
                    $('#ucabundle_inscription_'+dataIdSelect).select2('destroy');
                    $('#ucabundle_inscription_'+dataIdSelect+' option').each(function(index){
                        if($(this).attr('data-'+dataIdChanged+'-id') != idValue && idValue != 0){
                            $(this).attr('disabled','disabled');
                        }else{
                            $(this).removeAttr('disabled');
                        }
                    });
                    $('#ucabundle_inscription_'+dataIdSelect+' option[value="0"]').removeAttr('disabled');
                    $('#ucabundle_inscription_'+dataIdSelect).select2();
                    $('#ucabundle_inscription_'+dataIdSelect).val(0);
                    $('#ucabundle_inscription_'+dataIdSelect).trigger('change.select2');
                }
            });
        </script>

    {% endif %}
{% endblock %}
