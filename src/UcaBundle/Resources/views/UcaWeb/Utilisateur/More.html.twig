{% extends "@Uca/Common/Main/Structure.UcaWeb.html.twig" %}
{% import '@Uca/Macros/Dhtmlx.html.twig' as dhtmlxCalendar %}
{% import '@Uca/Macros/ImageAsset.html.twig' as ImageAsset %}
{% import '@Uca/Macros/FlashBag.html.twig' as flashBag %}

{% block stylesheets %}
  {{ parent() }}
  {{ ImageAsset.imageFondCssWithEmplacement('DÃ©faut') }}
{% endblock %}

{% block main %}
  {% include "@Uca/UcaWeb/Inscription/Modal.Desinscription.html.twig" %}
  <h1 class="h1-light">{{'utilisateur.planning'|trans}}</h1>
  <section class="container mb-5">

    {{ flashBag.showAll }}
    <div class="alert alert-success d-none" id="messageConfirmationMailSend" role="alert">
        {{ "monPlanning.more.mail.send.success"|trans }}
    </div>

    <div class="container-style bg-white mb-5">

      <h2 class="hide-border-title fs-21 fw-700 text-uppercase mb-5">{{ eventName }}
        ---
        {{ evenement.description }}</h2>

      <div class="row mb-5 d-flex flex-wrap">

        <div class="col-12 col-md-6 mb-4">
          <div class="row">
            <div class="col-12">
              <h2 class="hide-border-title fs-21 fw-700">{{ "monPlanning.more.horaires"|trans }}</h2>
              <p>
                <span class="fw-700">{{ "monPlanning.more.datedebut"|trans }}
                  :</span>
                {{ evenement.dateDebut|date('d/m/Y H:i:s') }}</p>
              <p>
                <span class="fw-700">{{ "monPlanning.more.datefin"|trans }}
                  :</span>
                {{ evenement.dateFin|date('d/m/Y H:i:s') }}</p>
            </div>
          </div>
          {% if (isEncadrant or app.user.hasRole('ROLE_GESTION_CRENEAU_LECTURE')) and form.appels is not empty %}
            <div class="row p-3">
              <div class="col-12 bg-isabelline p-3 text-center">
                <h2 class="hide-border-title fs-21 fw-700">{{ "monPlanning.more.mail.titre"|trans }}</h2>
                <button id="mailButton" class="btn btn-primary">{{ "monPlanning.more.mail.button"|trans }}</button>
              </div>
            </div>
          {% endif %}
        </div>
        {% if isEncadrant or app.user.hasRole('ROLE_GESTION_CRENEAU_LECTURE')  %}
          <div class="col-12 col-md-6 mb-4">

            {% if form.appels is empty %}
                <h2 class="hide-border-title fs-21 fw-700">{{ "monPlanning.more.appel.titre"|trans }}</h2>
                <p>{{ "monplanning.more.appel.empty"|trans }}</p>
            {% else %}
                <h2 class="hide-border-title fs-21 fw-700">
                    {{ "monPlanning.more.appel.titre"|trans }} 
                    <a class="btn-sm btn-primary btn-form" href='{{ path("UcaWeb_PlanningMore_listePdf", {id: evenement.id} )}}' title="{{'bouton.exportpdf'|trans}}" id="btn_export_liste_pdf">
                        <span class="fas fa-file-download"></span>
                    </a>                                                     
                </h2>
                <p>{{ "monPlanning.more.appel.texte"|trans }}</p>

                {{ form_start(form) }}
                <table style="width: 100%">
                    {% for appel in form.appels %}
                        <tr>
                            {% if inscriptions[loop.index0].statut == 'valide' %}
                                {% if inscriptions[loop.index0].utilisateur.telephone != null %}
                                    {% set name = inscriptions[loop.index0].utilisateur.nom ~ " " ~ inscriptions[loop.index0].utilisateur.prenom ~ ' (' ~ inscriptions[loop.index0].utilisateur.telephone|telephone ~ ')' %}
                                    <td style="width: 70%">
                                        {{ form_row(appel.present, {'label': name}) }}
                                    </td>
                                {% else %}
                                    {% set name = inscriptions[loop.index0].utilisateur.nom ~ " " ~ inscriptions[loop.index0].utilisateur.prenom  %}
                                    <td style="width: 70%">
                                        {{ form_row(appel.present, {'label': name}) }}
                                    </td>
                                {% endif %}
                            {% else %}
                                {% set name = inscriptions[loop.index0].utilisateur.nom ~ " " ~ inscriptions[loop.index0].utilisateur.prenom ~ " (" ~ "creneau.list.preinscrit"|trans ~ ")" %}
                                <td style="width: 70%">
                                    {{ form_row(appel.present, {'label': name}) }}
                                </td>
                            {% endif %}
                            <td>
                                <a href="{{ path('UcaWeb_PlanningMore_Desinscrire', {'user': inscriptions[loop.index0].utilisateur.id, 'evenement': evenement.id}) }}" data-toggle='modal' data-target='#modalDesinscription' style="color: white" class="btn btn-danger btn-form" title="{{"bouton.desinscrire"|trans}}">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </td>                                   
                        </tr>
                    {% endfor %}
                </table>     
                {{ form_end(form) }}
            {% endif %}

          </div>
        {% endif %}

      </div>
    </div>
  </section>


  {% include "@Uca/UcaWeb/Utilisateur/Modal.mail.html.twig" %}

{% endblock %}

{% block javascripts %}
  <script type="text/javascript">
    {% include "@Uca/Common/Modal/Modal.Information.js.twig" %}
    
    {% if not formMail.vars.valid %}
        $('#mailButton').click();
    {% endif %}
   
    var PATH_SEND_MAIL = '{{ path("UcaWeb_PlanningMore_mail", {id: evenement.id} ) }}'
    
    function  cocherDecocherTout(param) {
      destinataires = document.querySelectorAll( "input[id^='ucabundle_mail_destinataires']" );
      if (param == 'cocher') {
        destinataires.forEach( function ( elem ) {
          if ( ! elem.checked ) elem.checked = true;
        } )
      } else if ( param == 'decocher' ) {
        destinataires.forEach( function ( elem ) {
          if ( elem.checked ) elem.checked = false;
        } )
      }
    }
    $("#mailButton").on("click", function(){
      $('#modalMail').modal();
    });
    
    $(document).on('submit','#modalMailForm',function(event) {
      event.preventDefault();
      $.ajax({
        type: 'POST',
        url: PATH_SEND_MAIL,
        data: $(this).serialize(),
      }).done(function(resultat) {
        if(resultat.sucess){
          $('#modalMail').modal('toggle');
          $('#messageConfirmationMailSend').removeClass('d-none');
        } else{
          $("#modalMail form").replaceWith(resultat.form);
        }
      }).fail(_uca.ajax.fail);
    });

    $(document).on('click', '#ucabundle_mail_save', function(event){
      event.preventDefault();
      $("#modalMailForm").submit();
    })

  </script>
{% endblock %}
