{% extends "@Uca/Common/Main/Structure.UcaWeb.html.twig" %}
{% import '@Uca/Macros/Inscription.html.twig' as Inscription %}
{% import '@Uca/Macros/ImageAsset.html.twig' as ImageAsset %}

{% block title %}
  Uca Web
{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  {{ ImageAsset.imageFondCssWithUrl(item.activite.image) }}
{% endblock %}

{% block main %}

  <div class="container p-0 pl-4 pl-xl-0">
    {% include "@Uca/Common/Component/Bouton.Retour.html.twig" %}
  </div>
  <h1 class="h1-light">{{ item.libelle }}</h1>
  <section class="container container-style bg-white mb-5">
    {{ item.description|nl2br }}
  </section>
  {% include '@Uca/UcaWeb/Activite/BlocTarif.html.twig' with { format: item } %}
  
  {# TODO : revoir style #}
  <section class="container-style bg-white mb-5" id="sectionCalendrier" style="">
    {% include '@Uca/UcaWeb/Activite/Calendrier/FormatActivite.calendrier.html.twig' %}
  </section>
  
  {{ Inscription.HtmlModal }}
  
  {% include '@Uca/UcaWeb/Activite/BlocReservation.html.twig' %}

  <div id="js-text-inscrit-clone" class="d-none">
    <div class="color-blue">
      <i class="fas fa-check-circle"></i>
      <span>{{ "formatCreneau.list.preinscrit"|trans|upper }}</span>
    </div>
  </div>

  <div id="js-text-indisponible-clone" class="d-none">
    <p class="m-0 fs-14 fw-500 text-uppercase color-taupe-gray w-100 text-center">
      {{ 'common.indisponible' | trans | upper }}
      {% if app.user  %}
        <span class="d-inline-block" tabindex="0" data-toggle="tooltip" title="{{ 'bouton.indisponible.statut.nbcreneaumaxatteint' | trans({'%maxCreneau%': app.user.profil.nbMaxInscriptions}) }}" aria-label="{{  'bouton.indisponible.statut.nbcreneaumaxatteint' | trans({'%maxCreneau%': app.user.profil.nbMaxInscriptions}) }}">
          <i class="fas fa-question-circle"></i>
        </span>
      {% endif  %}
    </p>
  </div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  
  {{ Inscription.Js }}
  {{ encore_entry_script_tags('creneau') }}
  
  <script>
    $( document ).ready( function () 
    {
      createMap();
      $( '[data-toggle="tooltip"]' ).tooltip();
    } );
  </script>



  <script>
    
    var api_url = "{{ path('api_activite_creneau') }}";

    function hideLoader(){
      $("#load").hide();
    }
    function showLoader(){
      $("#load").show();
    }

    $(document).ready(function (){
      loadData();
    });

    $(window).resize(function(){
      $('.modal').modal('hide');
      loadData();
    })

    function changeTypeVisualisation(newTypeVisualisation){
      typeVisualisation = newTypeVisualisation;
      loadData();
    }

    function changePeriode(forNextPeriode, nbDays){
      var date = new Date(currentDate.replace( /(\d{2})\/(\d{2})\/(\d{4})/, "$2/$1/$3"));

      var facteur = forNextPeriode ? 1 : -1;
      if(typeVisualisation == "semaine"){
        date.setDate(date.getDate() + nbDays * facteur);
      } else if(typeVisualisation == "jour"){
        date.setDate(date.getDate() + 1 * facteur);
      } else if(typeVisualisation == "mois"){
        var oldMonth = date.getMonth();
        date.setMonth(date.getMonth() + 1 * facteur);
        while (date.getMonth() != oldMonth + 1 * facteur){
          date.setDate(date.getDate() - 1 * facteur * (date.getMonth() - oldMonth + 1 * facteur));
        }
      }

      var options = { day: '2-digit', year: 'numeric', month: '2-digit'};
      currentDate = date.toLocaleDateString("fr-FR", options);

      loadData();
    }

    function loadData(){
      let valueHeightDiv = [];
      let widthWindow = $(window).width();
      showLoader();
      $.post(api_url, {
        data: {
          itemId: itemId,
          typeVisualisation: typeVisualisation,
          currentDate: currentDate,
          typeFormat: typeFormat,
          idRessource: idRessource,
          widthWindow: widthWindow,
        }
      }, function (data) {
        $("#sectionCalendrier").text('');
        $("#sectionCalendrier").append(data.content);
        hideLoader();

        $('.js-inscription').each(_uca.inscription.addButtonEvent);
        $( '[data-toggle="tooltip"]' ).tooltip();

        $(".data-div").each(function(){
          valueHeightDiv.push($(this).height());
        })
        $('.cell-col-center').height(Math.max.apply(Math, valueHeightDiv));

        createMap();

      }).fail(_uca.ajax.fail);
    }

    function sendMail(idEvent, idEncadrant){
      let id = "#contactEncadrant"+idEvent+idEncadrant;
      let textareaId= "#textcontactEncadrant"+idEvent+idEncadrant;
      let message = $(textareaId).val();
      $.ajax({
        url: Routing.generate("api_mailencadrant"),
        type: "POST",
        data: {
          message: message,
          event: idEvent,
          encadrant: idEncadrant,
        },
      }).done(function(data){
        if(data!=null){
          if(data['response'] == "success"){
            setTimeout(function() {alert("{{ 'mail.success'|trans }}")}, 2000);
            $(textareaId).val("");
            $(id).removeClass("show");
          } else {
            setTimeout(function() {alert("{{ 'mail.error'|trans }}")}, 2000);
          }
          
        }
      }).fail(_uca.ajax.fail);
    }

    function createMap(){
      _uca.openlayersmap.init();
      $('.js-openlayersmap').each(_uca.openlayersmap.createmap);
    }
  </script>
{% endblock %}
